{% extends 'base.html' %}

{% block content %}
    <h3>Room {{ room.name }}</h3>
    <div id="chat-messages">
        {% for message in messages %}
            <p><strong>{{ message.user.username }}</strong>: {{ message.body }}</p>
        {% endfor %}
    </div>
    <form method="post">
        {% csrf_token %}
        <input id="message" type="text">
        <button id="send-button">Send</button>
    </form>
    {{ request.user.username|json_script:"username" }}
    {{ room.slug|json_script:"room-slug" }}


    <script>
        const username = JSON.parse(document.getElementById("username").textContent)
        const room_slug = JSON.parse(document.getElementById("room-slug").textContent)
        const address = window.location.host
        ws = new WebSocket(
            'ws://'
            + address
            + "/ws/"
            + room_slug
            + "/"
        )
        document.getElementById("send-button").onclick = function (e) {
            e.preventDefault()
            const textinput = document.getElementById("message")
            const message = textinput.value
            textinput.value = ""
            if (message) {
                ws.send(
                    JSON.stringify({
                            "message": message,
                            "username": username,
                            "room": room_slug
                        }
                    )
                )

            }


        }

        ws.onmessage = function (e) {
            msg = JSON.parse(e.data)
            console.log(msg)
            let html = '<p><strong>'
            html += msg.username ? msg.username : 'anonim'
            html += ':</strong> ' + msg.message + '</p>'
            document.getElementById("chat-messages").innerHTML += html
        }

    </script>

{% endblock %}